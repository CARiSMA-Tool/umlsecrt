IMPORTS{
  import java.util.LinkedList;
  import java.util.HashMap;
  import java.util.Set;
  import java.util.Map;
  import java.util.Collection;
  import java.util.Collections;
  
  import java.nio.file.Files;
  import java.nio.file.Paths;
  
  import com.google.gson.Gson;
  
  import good.MethodSetCall;
  import good.MethodGetCall;
  import cwe.CWE200GetMethodCall;
  import cwe.CWE807MethodSetCall;
  import secret.ProtectedValues;
  
}
GLOBAL{
  VARIABLES{
    LinkedList<String> stack = new LinkedList<>();
    Map<String,Collection<String>> secrecyMap =  readSecurityLevels("secrecy.json");
    Map<String,Collection<String>> integrityMap =  readSecurityLevels("integrity.json");
  }
  EVENTS{
    enterM1(String id) = {CWE200GetMethodCall.run(*)} where id = "CWE200GetMethodCall.run";
    enterM2(String id) = {CWE807MethodSetCall.run(*)} where id = "CWE807MethodSetCall.run";
    enterM3(String id) = {MethodSetCall.run(*)} where id = "MethodSetCall.run";
    enterM4(String id) = {MethodGetCall.run(*)} where id = "MethodGetCall.run";
    enterM5(String id) = {ProtectedValues.setValue(*)} where id = "ProtectedValues.setValue";
    enterM6(String id) = {ProtectedValues.getValue(*)} where id = "ProtectedValues.getValue";
    enterMethod() = {enterM1|enterM2|enterM3|enterM4|enterM5|enterM6}
    returnM1() = {CWE200GetMethodCall.run(*)uponReturning(*)}
    returnM2() = {CWE807MethodSetCall.run(*)uponReturning(*)}
    returnM3() = {MethodSetCall.run(*)uponReturning(*)}
    returnM4() = {MethodGetCall.run(*)uponReturning(*)}
    returnM5() = {ProtectedValues.setValue(*)uponReturning(*)}
    returnM6() = {ProtectedValues.getValue(*)uponReturning(*)}
    exitMethod() = {returnM1}
  }
  PROPERTY secureDependency{
    STATES{
      BAD{bad {System.err.println("Illegal Access");System.exit(-1);}}
      STARTING{ok}
    }
    TRANSITIONS {
      ok -> ok [exitMethod \ \ stack.pop();]
      ok -> bad [enterMethod \ !checkSecureDependency(stack.peek(),id) \ ]
      ok -> ok [enterMethod \ \ System.out.println("Push: "+id);stack.push(id); ]
    }
  }
}
METHODS{
  boolean checkSecureDependency(String caller, String callee){
  	System.out.println("Check: "+caller+" -> "+callee); 
    if(caller == null) {
      return true;
    }
    return checkSecrecy(caller,callee) && checkIntegrity(caller, callee);
  }
  
  boolean checkSecrecy(String caller, String callee){
    Collection<String> calleeSecrecy = secrecyMap.getOrDefault(callee, Collections.emptySet());
    if(secrecyMap.get(caller).contains(callee)) {
      return calleeSecrecy.contains(callee);
    }
    return !calleeSecrecy.contains(callee);
  }
  
  boolean checkIntegrity(String caller, String callee){
    Collection<String> calleeIntegrity = integrityMap.getOrDefault(callee, Collections.emptySet());
    if(secrecyMap.get(caller).contains(callee)) {
      return calleeIntegrity.contains(callee);
    }
    return !calleeIntegrity.contains(callee);
  }
  
  Map<String, Collection<String>> readSecurityLevels(String path) {
    try {
      return (Map<String, Collection<String>>) new Gson().fromJson(Files.newBufferedReader(Paths.get(path)), Map.class);
    } catch (Exception e) {
      e.printStackTrace();
      System.exit(-1);
    }
    return null;
  }
}
